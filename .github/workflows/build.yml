name: Build PulseView (multi-platform)

on:
  workflow_dispatch:
    inputs:
      pulseview_ref:
        description: "pulseview ref (branch/tag/SHA)"
        required: true
        default: "master"
      libsigrok_repo:
        description: "libsigrok repository (owner/repo or owner:branch)"
        required: true
        default: "rssdev10/libsigrok"
      libsigrok_ref:
        description: "libsigrok ref (branch/tag/SHA)"
        required: true
        default: "siglent_sds800"
      libsigrokdecode_ref:
        description: "libsigrokdecode ref (branch/tag/SHA)"
        required: true
        default: "master"
      libserialport_ref:
        description: "libserialport ref (branch/tag/SHA)"
        required: true
        default: "master"
      sigrok_cli_ref:
        description: "sigrok-cli ref (branch/tag/SHA) (optional, but commonly needed in bundles)"
        required: true
        default: "master"
      sigrok_util_ref:
        description: "sigrok-util ref (branch/tag/SHA)"
        required: true
        default: "master"

      # Optional toggles
      build_windows_arm64:
        description: "Build Windows arm64 (requires self-hosted runner/toolchain; default false)"
        required: true
        default: "false"

permissions:
  contents: read

concurrency:
  group: pulseview-${{ github.workflow }}-${{ github.ref }}-${{ github.event.inputs.pulseview_ref }}
  cancel-in-progress: false

env:
  SIGROK_ORG: sigrokproject
  LIBSIGROK_REPO: ${{ github.event.inputs.libsigrok_repo }}
  LIBSIGROK_REF: ${{ github.event.inputs.libsigrok_ref }}
  LIBSIGROKDECODE_REF: ${{ github.event.inputs.libsigrokdecode_ref }}
  LIBSERIALPORT_REF: ${{ github.event.inputs.libserialport_ref }}
  SIGROK_CLI_REF: ${{ github.event.inputs.sigrok_cli_ref }}
  SIGROK_UTIL_REF: ${{ github.event.inputs.sigrok_util_ref }}
  PULSEVIEW_REF: ${{ github.event.inputs.pulseview_ref }}
  DEPS_DIR: ${{ github.workspace }}/deps
  OUT_DIR:  ${{ github.workspace }}/out
  # Keep builds deterministic-ish
  CMAKE_BUILD_PARALLEL_LEVEL: "3"

jobs:
  linux_appimage:
    name: Linux AppImage (${{ matrix.arch }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        # Disable aarch64 for now due to QEMU segfaults - can enable later with native ARM runners
        arch: [x86_64]  
        # arch: [x86_64, aarch64]
    steps:
      - uses: actions/checkout@v4

      - name: Install host prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git ca-certificates bash coreutils \
            python3 python3-pip \
            qemu-user-static binfmt-support

      - name: Build AppImage (native x86_64)
        if: matrix.arch == 'x86_64'
        env:
          TARGET_ARCH: x86_64
        run: |
          bash scripts/build_linux_appimage.sh

      - name: Build AppImage (emulated aarch64)
        if: matrix.arch == 'aarch64'
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y --no-install-recommends \
              git ca-certificates bash coreutils \
              python3 python3-pip \
              build-essential curl file patchelf
          run: |
            bash scripts/build_linux_appimage.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pulseview-linux-${{ matrix.arch }}
          path: out/linux/${{ matrix.arch }}/*
          if-no-files-found: error

  windows_mxe_amd64:
    name: Windows (MXE, amd64)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install host prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git ca-certificates bash coreutils autoconf automake libtool libtool-bin pkg-config \
            autopoint gperf intltool lzip python3-mako

      - name: Build Windows (MXE) artifact
        run: |
          bash scripts/build_windows_mxe.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pulseview-windows-amd64
          path: out/windows/amd64/*
          if-no-files-found: error

  windows_arm64_placeholder:
    name: Windows arm64 (placeholder)
    if: ${{ github.event.inputs.build_windows_arm64 == 'true' }}
    runs-on: windows-latest
    steps:
      - run: |
          echo "Windows arm64 build is not implemented for GitHub-hosted runners."
          echo "Typical options:"
          echo "  - self-hosted Windows ARM64 runner + MSVC toolchain"
          echo "  - or cross-compile with clang/llvm + vcpkg and an ARM64 sysroot"
          exit 1

  macos:
    name: macOS (${{ matrix.target }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # ARM64 GitHub-hosted macOS runners exist (macos-14 arm64)
          - target: arm64
            runs_on: macos-14
          # Intel is supported via macos-15-large (macOS 15 on Intel)
          - target: amd64
            runs_on: macos-15-large
    runs-on: ${{ matrix.runs_on }}

    steps:
      - uses: actions/checkout@v4

      - name: Install prerequisites (Homebrew)
        run: |
          brew update
          brew install git cmake ninja pkg-config autoconf automake libtool gettext glib glibmm \
                       libzip libusb libftdi boost python@3.11 qt@5

      - name: Build macOS bundle
        env:
          MAC_TARGET: ${{ matrix.target }}
        run: |
          bash scripts/build_macos_bundle.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pulseview-macos-${{ matrix.target }}
          path: out/macos/${{ matrix.target }}/*
          if-no-files-found: error
